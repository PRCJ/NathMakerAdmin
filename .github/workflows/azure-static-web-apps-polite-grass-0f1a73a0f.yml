name: Azure Static Web Apps CI/CD
on:
  push:
    branches:
      - master
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches:
      - master

jobs:
  build_and_deploy_job:
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
    runs-on: ubuntu-latest
    name: Build and Deploy Job
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true
          lfs: false
      
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Set up Gradle
        uses: gradle/gradle-build-action@v2
      
      - name: Make gradlew executable
        run: chmod +x ./gradlew
      
      - name: Upgrade Kotlin package lock
        run: ./gradlew kotlinUpgradePackageLock
      
      - name: Build Kotlin/JS project
        run: |
          echo "=== Building Kotlin/JS project ==="
          ./gradlew :frontend:build --no-daemon
          ./gradlew :frontend:jsBrowserProductionWebpack --no-daemon || echo "Webpack task failed or not available"
          ./gradlew :frontend:jsBrowserDistribution --no-daemon || echo "Distribution task failed or not available"
          
      - name: Find and prepare deployment files
        run: |
          echo "=== Build output structure ==="
          find ./frontend/build -type f | head -30
          
          mkdir -p ./deployment
          
          # Find the main JavaScript file using multiple strategies
          MAIN_JS=""
          
          # Strategy 1: Look in processedResources (most common for Kotlin/JS)
          if [ -d "./frontend/build/processedResources/js/main" ]; then
            echo "Searching in processedResources..."
            MAIN_JS=$(find ./frontend/build/processedResources/js/main -name "*.js" -type f | head -1)
          fi
          
          # Strategy 2: Look in distributions
          if [ -z "$MAIN_JS" ]; then
            echo "Searching in distributions..."
            MAIN_JS=$(find ./frontend/build -path "*/distributions/*" -name "*.js" -type f | head -1)
          fi
          
          # Strategy 3: Extract from JAR (Kotlin/JS compilation artifact)
          if [ -z "$MAIN_JS" ]; then
            echo "No loose JS files found, checking JAR files..."
            JAR_FILE=$(find ./frontend/build -name "*.jar" -type f | head -1)
            if [ -n "$JAR_FILE" ]; then
              echo "Found JAR: $JAR_FILE"
              mkdir -p ./temp_jar_extract
              cd ./temp_jar_extract
              if command -v unzip >/dev/null 2>&1; then
                unzip -q "../$JAR_FILE" 2>/dev/null || true
              elif command -v jar >/dev/null 2>&1; then
                jar -xf "../$JAR_FILE" 2>/dev/null || true
              fi
              
              # Find JS file in extracted content
              EXTRACTED_JS=$(find . -name "*.js" -type f | head -1)
              if [ -n "$EXTRACTED_JS" ]; then
                echo "Extracted JS from JAR: $EXTRACTED_JS"
                cp "$EXTRACTED_JS" ../deployment/app.js
                MAIN_JS="app.js"
              fi
              cd ..
              rm -rf ./temp_jar_extract
            fi
          fi
          
          # Strategy 4: General search as fallback
          if [ -z "$MAIN_JS" ]; then
            echo "Final search for any JS files..."
            MAIN_JS=$(find ./frontend/build -name "*.js" -type f ! -name "*.map" | head -1)
          fi
          
          if [ -z "$MAIN_JS" ]; then
            echo "ERROR: No JavaScript files found!"
            echo "Available files:"
            find ./frontend/build -type f | grep -E "\.(js|jar)$" || echo "No JS or JAR files found"
            exit 1
          fi
          
          # Copy main JS file if not already copied from JAR extraction
          if [ "$MAIN_JS" != "app.js" ]; then
            JS_FILENAME=$(basename "$MAIN_JS")
            cp "$MAIN_JS" "./deployment/$JS_FILENAME"
            MAIN_JS="$JS_FILENAME"
          fi
          
          echo "Main JS file: $MAIN_JS"
          
          # Copy all web assets from processedResources
          if [ -d "./frontend/build/processedResources" ]; then
            echo "Copying web assets from processedResources..."
            find ./frontend/build/processedResources -type f \( -name "*.css" -o -name "*.png" -o -name "*.jpg" -o -name "*.svg" -o -name "*.ico" -o -name "*.woff" -o -name "*.woff2" -o -name "*.ttf" -o -name "*.json" \) -exec cp {} ./deployment/ \; 2>/dev/null || true
          fi
          
          # Copy static assets if they exist
          for assets_dir in "./frontend/build/static" "./frontend/build/assets" "./frontend/build/public"; do
            if [ -d "$assets_dir" ]; then
              echo "Copying from $assets_dir..."
              cp -r "$assets_dir"/* ./deployment/ 2>/dev/null || true
            fi
          done
          
          # Create index.html file
          cat > ./deployment/index.html << EOF
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>NathMaker Admin</title>
              <style>
                  * {
                      margin: 0;
                      padding: 0;
                      box-sizing: border-box;
                  }
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
                      line-height: 1.6;
                      color: #333;
                      background-color: #f5f5f5;
                  }
                  #root {
                      min-height: 100vh;
                      display: flex;
                      flex-direction: column;
                  }
                  .loading {
                      display: flex;
                      justify-content: center;
                      align-items: center;
                      height: 100vh;
                      font-size: 18px;
                  }
              </style>
          </head>
          <body>
              <div id="root">
                  <div class="loading">Loading NathMaker Admin...</div>
              </div>
              <script>
                  window.addEventListener('error', function(e) {
                      console.error('Application error:', e.error);
                      document.getElementById('root').innerHTML = '<div class="loading" style="color: #e74c3c;">Failed to load application. Please refresh the page.</div>';
                  });
              </script>
              <script src="$MAIN_JS"></script>
          </body>
          </html>
          EOF
          
          echo "=== Deployment directory contents ==="
          ls -la ./deployment/
          
          echo "=== Verifying main JS file ==="
          if [ -f "./deployment/$MAIN_JS" ]; then
            echo "Main JS file size: $(wc -c < "./deployment/$MAIN_JS") bytes"
            echo "First 100 characters:"
            head -c 100 "./deployment/$MAIN_JS"
            echo ""
          else
            echo "ERROR: Main JS file not found!"
            exit 1
          fi
      
      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_POLITE_GRASS_0F1A73A0F }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "./deployment"
          api_location: ""
          output_location: ""
          skip_app_build: true

  close_pull_request_job:
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    name: Close Pull Request Job
    steps:
      - name: Close Pull Request
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_POLITE_GRASS_0F1A73A0F }}
          action: "close"
