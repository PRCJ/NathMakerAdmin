name: Frontend CI/CD to Azure Static Web Apps

on:
  push:
    branches: [master]
    paths: ['frontend/**', '.github/workflows/**']  # Only run when frontend changes
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches: [master]
    paths: ['frontend/**']

jobs:
  build_and_deploy_job:
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
    runs-on: ubuntu-latest
    name: Build and Deploy Frontend
    steps:
      - uses: actions/checkout@v4  # Updated to v4
        with:
          submodules: true
          lfs: false
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4  # Updated to v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
        with:
          cache-disabled: false
      
      - name: Make gradlew executable
        run: chmod +x ./gradlew
      
      - name: Build Kotlin/JS Frontend
        run: |
          echo "Building frontend for production..."
          
          # Clean first to avoid stale artifacts
          ./gradlew :frontend:clean --no-daemon --info
          
          # Build the frontend
          ./gradlew :frontend:build --no-daemon --info
          
          # Try the standard Kotlin/JS production webpack task
          ./gradlew :frontend:jsBrowserProductionWebpack --no-daemon --info || echo "Webpack task not found, trying alternatives..."
          
          # Alternative: try distribution task
          ./gradlew :frontend:jsBrowserDistribution --no-daemon --info || echo "Distribution task not found"
      
      - name: Locate and Prepare Frontend Assets
        run: |
          echo "=== Searching for built frontend assets ==="
          
          # Common Kotlin/JS build output locations
          POSSIBLE_DIRS=(
            "./frontend/build/dist/js/productionExecutable"
            "./frontend/build/distributions"
            "./frontend/build/processedResources/js/main"
            "./frontend/build/compileSync/js/main/productionExecutable/kotlin"
            "./frontend/build/js/packages/frontend/kotlin"
          )
          
          BUILD_DIR=""
          for dir in "${POSSIBLE_DIRS[@]}"; do
            if [ -d "$dir" ] && [ "$(ls -A $dir 2>/dev/null)" ]; then
              BUILD_DIR="$dir"
              echo "Found build directory: $BUILD_DIR"
              break
            fi
          done
          
          if [ -z "$BUILD_DIR" ]; then
            echo "Searching for any JS files in build directory..."
            find ./frontend/build -name "*.js" -type f | head -10
            
            echo "Build directory structure:"
            find ./frontend/build -type d | head -20
            
            echo "ERROR: Could not locate frontend build output"
            exit 1
          fi
          
          # Create deployment directory
          mkdir -p ./deployment
          
          # Copy all files from build directory
          echo "Copying files from $BUILD_DIR to deployment..."
          cp -r "$BUILD_DIR"/* ./deployment/ 2>/dev/null || echo "No files to copy with /*"
          
          # Look for the main JS file
          MAIN_JS=$(find ./deployment -name "*.js" -not -name "*.map" | head -1)
          if [ -z "$MAIN_JS" ]; then
            echo "ERROR: No JavaScript files found in deployment directory"
            ls -la ./deployment/
            exit 1
          fi
          
          MAIN_JS_NAME=$(basename "$MAIN_JS")
          echo "Main JS file: $MAIN_JS_NAME"
          
          # Create index.html that calls your API
          cat > ./deployment/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>NathMaker Admin</title>
              <style>
                  body { 
                      margin: 0; 
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
                  }
                  #root { 
                      min-height: 100vh; 
                  }
                  .loading { 
                      display: flex; 
                      justify-content: center; 
                      align-items: center; 
                      height: 100vh; 
                  }
              </style>
          </head>
          <body>
              <div id="root">
                  <div class="loading">Loading NathMaker Admin...</div>
              </div>
              
              <script>
                  // Configure API base URL - matches your frontend code
                  window.API_BASE_URL = 'https://api.nathmakers.com';
                  
                  // Add CORS handling if needed
                  window.addEventListener('error', function(e) {
                      console.error('Application error:', e.error);
                  });
                  
                  // Debug logging for API calls
                  console.log('API Base URL configured:', window.API_BASE_URL);
              </script>
              
              <script src="MAIN_JS_PLACEHOLDER"></script>
          </body>
          </html>
          EOF
          
          # Replace placeholder with actual JS filename
          sed -i "s/MAIN_JS_PLACEHOLDER/$MAIN_JS_NAME/g" ./deployment/index.html
          
          echo "=== Deployment directory contents ==="
          ls -la ./deployment/
          
          echo "=== Generated index.html ==="
          cat ./deployment/index.html
      
      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_POLITE_GRASS_0F1A73A0F }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "./deployment"
          api_location: ""  # No API - using external api.nathmaker.com
          output_location: ""
          skip_app_build: true
          skip_api_build: true  # Important: skip API build

  close_pull_request_job:
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    name: Close Pull Request Job
    steps:
      - name: Close Pull Request
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_POLITE_GRASS_0F1A73A0F }}
          action: "close"
